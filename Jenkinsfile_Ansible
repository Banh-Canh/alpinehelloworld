pipeline {
        agent none
	stages {
		stage('Build image') {
			agent any
			steps {
				script {
					sh 'docker build -t $DOCKERHUB_LOGIN/$IMAGE_NAME:$IMAGE_TAG .'
				}
			}
		}
		stage('Start Container') {
			agent any
			steps {
				script {
					sh 'docker run -it --name ${IMAGE_NAME} -p 5000:5000 -d -e PORT=5000 ${DOCKERHUB_LOGIN}/${IMAGE_NAME}:${IMAGE_TAG}'
				}
			}
		}
		stage('Test Container') {
			agent any
			steps {
				script {
					sh '''
					    sleep 5
						var=$(curl http://172.17.0.1:5000)
						if [ "$var" = 'Hello world!' ]; then exit 0; else exit 1; fi
					'''
				}
			}
		}
		stage('Clean Container') {
			agent any
			steps {
				script {
					sh 'docker rm -f ${IMAGE_NAME}'
				}
			}
		}
		stage('Push image on dockerhub') {
			agent any 
			environment {
				DOCKERHUB_SECRET = credentials('dockerhub_secret')
			}
			steps {
				script {
					sh '''
					docker login --username ${DOCKERHUB_SECRET_USR} --password ${DOCKERHUB_SECRET_PSW}
					docker push ${DOCKERHUB_LOGIN}/${IMAGE_NAME}:${IMAGE_TAG}
					'''
				}
			}
		}
		stage('Ansible deploy') {
			agent { 
				docker {
						image 'registry.gitlab.com/robconnolly/docker-ansible:latest' 
				} 
			}
			steps {
				script {
					sh '''
                                                apt update
                                                apt install software-properties-common -y
                                                apt install sshpass -y
						cd ansible
						ansible-playbook -i prod.yml install-docker.yml
						ansible-playbook -i prod.yml alpinehelloworld.yml
					'''
				}
			}
		}
		stage('Tests Availability') {
                        agent {
                                docker {
                                                image 'registry.gitlab.com/robconnolly/docker-ansible:latest'
                                }
                        }
                        steps {
                                script {
                                        sh '''
                                                apt update
                                                apt install software-properties-common -y
                                                apt install sshpass -y
                                                ansible-playbook -i ansible/prod.yml test.yml
                                        '''
                                }
                        }
                }
	}
}
