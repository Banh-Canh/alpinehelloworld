pipeline {
        agent none
	stages {
		stage('Build image') {
			agent { 
				docker {
						image 'registry.gitlab.com/robconnolly/docker-ansible:latest' 
				} 
			}
			steps {
				script {
					sh '''
                                                apt update
                                                apt install software-properties-common -y
                                                apt install sshpass -y
						cd ansible
						ansible-playbook -i prod.yml install-docker.yml
						ansible-playbook -i prod.yml alpinehelloworld.yml
					'''
				}
			}
		}
		stage('Tests Availability') {
                        agent {
                                docker {
                                                image 'registry.gitlab.com/robconnolly/docker-ansible:latest'
                                }
                        }
                        steps {
                                script {
                                        sh '''
                                                apt update
                                                apt install software-properties-common -y
                                                apt install sshpass -y
                                                ansible-playbook -i ansible/prod.yml test.yml
                                        '''
                                }
                        }
                }
	}
}
